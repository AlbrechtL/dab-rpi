<!DOCTYPE html>
<html>
    <head>
        <title>welle-io web</title>
        <meta charset="UTF-8">
<style>
body {
    background-color: linen;
    font-family: Verdana, sans-serif;
}
table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
}
th, td {
    padding: 5px;
    text-align: left;
}
table#servicetable tr:nth-child(even) {
    background-color: #eee;
}
table#servicetable tr:nth-child(odd) {
    background-color: linen;
}
table#servicetable th {
    color: white;
    background-color: #444;
}
</style>
    </head>
    <body>
        <div>
            <p>Ensemble:</p>
            <div id="ensembleinfo"></div>
            <div id="images"></div>
            <div>Spectrum <canvas id="spectrum" width="512" height="150" style="border:1px solid #d3d3d3;">
                    Your browser doesn't support canvas</canvas>
            CIR: <canvas id="cir" width="512" height="150" style="border:1px solid #d3d3d3;">
                    Your browser doesn't support canvas</canvas>
            </div>
            <div id="tiiinfo"></div>
        </div>
        <div>
            <audio id="player" controls>
                <!--<source src="/mp3/0x4f57" type="audio/mpeg"> -->
            </audio>
        </div>
    <script>
var ensembleInfoTimer = setInterval(populateEnsembleinfo, 1000);

var plotTimer = setInterval(populatePlots, 240);

function ensembleInfoTemplate() {
    var html = '<p>Label: <b>${name}</b></p>';
    html += '<p>SNR: ${SNR}</p>';
    html += '<p>Freq corr: ${FrequencyCorrection}</p>';
    html += '<p>Date:${year}-${month}-${day} ${hour}:${minutes} UTC</p>';
    html += '<p>Services:</p>';
    html += '<table id="servicetable">'
    html += '<tr><th>Label</th> <th>SId</th> <th>bitrate</th> <th>samplerate</th> <th>DLS</th> <th></th></tr>';
    html += '${services}</table>';
    return html;
}

function serviceTemplate() {
    var html = '<tr><td>${Label}</td> <td>${SId}</td> <td>${bitrate}kbps</td> <td>${samplerate}Hz</td> <td></i>${dls}</i></td>';
    html += '<td><button type=button onclick="setPlayerSource(${SId})">Play</button></td>';
    html += '</tr>';
    return html;
}

function tiiTemplate() {
    var html = '<li>MainId ${pattern} SubId ${comb} ${delay} samples = <b>${delay_km} km</b>';
    html += ' error: ${error}</li>';
    return html;
}

function setPlayerSource(sid) {
    document.getElementById("player").src = "/mp3/" + sid;
    document.getElementById("player").load();
    document.getElementById("player").play();
}

function parseTemplate(template, data) {
   return template.replace(/\$\{(\w+)\}/gi, function(match, parensMatch) {
     if (data[parensMatch] !== undefined) {
       return data[parensMatch];
     }

     return match;
   });
}


function populateEnsembleinfo() {
    var r = new XMLHttpRequest();
    r.onreadystatechange = function () {
        if (r.readyState != 4 || r.status != 200) return;
        var data = JSON.parse(r.responseText);

        var servicehtml = "";
        var imageshtml = "";
        for (key in data["Services"]) {
            var service = data["Services"][key];
            var s = {};
            s["Label"] = service["Label"];
            s["SId"] = service["SId"];
            s["bitrate"] = service["Components"][0]["Subchannel"]["Bitrate"];
            s["samplerate"] = service["samplerate"];
            s["dls"] = service["dls"]["label"];

            imageshtml += ' <img width=128 height=96 src="' +
                "data:" + service["mot"]["type"] + ";base64," +
                service["mot"]["data"] + '">';

            servicehtml += parseTemplate(serviceTemplate(), s)
        }

        var ens = {};
        ens["name"] = data["Ensemble"]["Name"];
        ens["year"] = data["UTCTime"]["year"];
        ens["month"] = data["UTCTime"]["month"];
        ens["day"] = data["UTCTime"]["day"];
        ens["hour"] = data["UTCTime"]["hour"];
        ens["minutes"] = data["UTCTime"]["minutes"];

        ens["SNR"] = data["SNR"];
        ens["FrequencyCorrection"] = data["FrequencyCorrection"];
        ens["services"] = servicehtml;

        var ei = document.getElementById('ensembleinfo');
        ei.innerHTML = parseTemplate(ensembleInfoTemplate(), ens);

        document.getElementById('images').innerHTML = imageshtml;

        tiihtml = "<ul>";
        for (key in data["TII"]) {
            tiihtml += parseTemplate(tiiTemplate(), data["TII"][key])
        }
        tiihtml += "</ul>";

        var tii_el = document.getElementById('tiiinfo');
        tii_el.innerHTML = tiihtml;
    };
    r.open("GET", "/mux.json", true);
    r.send()
};

function plot(data, id, scalefactor, shiftfactor, plot_ix) {
    var canvas = document.getElementById(id);
    var ctx = canvas.getContext("2d");
    if (plot_ix == 0) {
        ctx.fillStyle = "#111100";
        ctx.fillRect(0,0,data.length,150);
    }

    ctx.beginPath();
    colors = ["#FF4444", "#33FF55", "#778800"];
    if (plot_ix < colors.length) {
        ctx.strokeStyle=colors[plot_ix];
    }
    else {
        ctx.strokeStyle=colors[0];
    }
    var dataMax = 0;
    var dataMin = 1000;
    for (var i = 0; i < data.length; i++) {
        var dataScaled = 170-scalefactor*(data[i] + shiftfactor);

        if (dataMax < dataScaled) {
            dataMax = dataScaled;
        }

        if (dataMin > dataScaled) {
            dataMin = dataScaled;
        }

        if (i % 4 == 0) {
            ctx.moveTo(i/4, dataMin);
            ctx.lineTo(i/4, dataMax);

            dataMax = 0;
            dataMin = 1000;
        }
    }
    ctx.stroke();
};

function populatePlots() {
    populateSpectrum();
    populateCIR();
};

function populateSpectrum() {
    var r = new XMLHttpRequest();
    r.onload = function(oEvent) {
        var arrayBuffer = r.response;
        if (arrayBuffer) {
            var spec = new Float32Array(arrayBuffer);
            plot(spec, "spectrum", 2, 20, 0);
        }

        r2 = new XMLHttpRequest();
        r2.onload = function(oEvent) {
            var arrayBuffer = r2.response;
            if (arrayBuffer) {
                var spec = new Float32Array(arrayBuffer);
                plot(spec, "spectrum", 2, 20, 1);
            }
        };
        r2.open("GET", "/nullspectrum", true);
        r2.responseType = "arraybuffer";
        r2.send(null);
    };
    r.open("GET", "/spectrum", true);
    r.responseType = "arraybuffer";
    r.send(null);
};

function populateCIR() {
    var r = new XMLHttpRequest();
    r.onload = function(oEvent) {
        var arrayBuffer = r.response;
        if (arrayBuffer) {
            var cir = new Float32Array(arrayBuffer);
            plot(cir, "cir", 4, 30, 0)
        }
    };
    r.open("GET", "/impulseresponse", true);
    r.responseType = "arraybuffer";
    r.send(null);
}

    </script>
    </body>
</html>
